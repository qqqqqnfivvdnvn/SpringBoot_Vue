package com.example.demo.service;import com.example.demo.apidata.ApiHaosen;import com.example.demo.dto.ApiResponseDTO;import com.example.demo.dto.HaoSenAppealConditionDTO;import com.example.demo.dto.HaoSenFileMessageDTO;import com.example.demo.mapper.HaoSenAppealDataMapper;import com.example.demo.mapper.HaoSenSqlMapper;import com.example.demo.service.impl.HaoSenAppealDataService;import com.example.demo.utils.HaoSenAppealExcelReader;import com.example.demo.utils.WebToExcel;import com.example.demo.vo.HaoSenAppealDataVO;import com.example.demo.vo.HaoSenInputAppealDataVO;import com.fasterxml.jackson.databind.JsonNode;import com.fasterxml.jackson.databind.ObjectMapper;import com.github.pagehelper.PageHelper;import com.github.pagehelper.PageInfo;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.beans.factory.annotation.Value;import org.springframework.http.*;import org.springframework.stereotype.Service;import org.springframework.web.multipart.MultipartFile;import java.net.URLEncoder;import java.nio.charset.StandardCharsets;import java.nio.file.Files;import java.nio.file.Path;import java.nio.file.Paths;import java.nio.file.StandardCopyOption;import java.util.List;import java.util.Objects;@Servicepublic class HaoSenAppealDataServiceImpl implements HaoSenAppealDataService {    @Autowired    private HaoSenAppealDataMapper appealDataMapper;    @Autowired    private HaoSenSqlMapper sqlMapper;    //申诉数据查看逻辑    @Override    public ApiResponseDTO<PageInfo<HaoSenAppealDataVO>> getAppealData(HaoSenAppealConditionDTO condition, int pageNum,                                                                      int pageSize) {        PageHelper.startPage(pageNum, pageSize);        List<HaoSenAppealDataVO> appealData = appealDataMapper.getAppealData(condition);        PageInfo<HaoSenAppealDataVO> pageInfo = new PageInfo<>(appealData);        return ApiResponseDTO.success(pageInfo);    }    //申诉数据导出逻辑    @Override    public ApiResponseDTO<byte[]> exportAppealDataExcel(HaoSenAppealConditionDTO condition) {        List<HaoSenAppealDataVO> appealData = appealDataMapper.getAppealData(condition);        // 调用字段映射        WebToExcel webToExcel = new WebToExcel();        // 导出Excel        byte[] excelBytes = webToExcel.exportToExcel(appealData);        // 设置响应头        HttpHeaders headers = new HttpHeaders();        headers.setContentType(MediaType.APPLICATION_OCTET_STREAM);        headers.setContentDispositionFormData("attachment",                URLEncoder.encode("申诉数据.xlsx", StandardCharsets.UTF_8));        ResponseEntity<byte[]> responseEntity = new ResponseEntity<>(excelBytes, headers, HttpStatus.OK);        return ApiResponseDTO.success(responseEntity.getBody());    }    //申诉数据导入逻辑    @Value("${file.upload-dir}" + "\\appeal_file")    private String uploadDir;    @Override    public ApiResponseDTO<HaoSenFileMessageDTO> uploadAppealFile(MultipartFile file) {        HaoSenFileMessageDTO fileMessage = new HaoSenFileMessageDTO();        try {            // 1. 保存文件到服务器（非事务操作）            Path uploadPath = Paths.get(uploadDir);            if (!Files.exists(uploadPath)) {                Files.createDirectories(uploadPath);            }            Path filePath = uploadPath.resolve(Objects.requireNonNull(file.getOriginalFilename()));            Files.copy(file.getInputStream(), filePath, StandardCopyOption.REPLACE_EXISTING);            // 2. 解析Excel            HaoSenAppealExcelReader reader = new HaoSenAppealExcelReader();            List<HaoSenInputAppealDataVO> appeals = reader.readExcel(filePath.toString(), HaoSenInputAppealDataVO.class);            if (appeals.isEmpty()) {                fileMessage.setMessage("文件内容为空");                fileMessage.setAppealMessage("申诉数据导入失败");                return ApiResponseDTO.success(fileMessage);            }            // 3. 数据库操作（事务内）            sqlMapper.deleteAllHaoSenData();            // 3. 清空并导入数据（事务操作）            for (HaoSenInputAppealDataVO appeal : appeals) {                sqlMapper.inputHaoSenData(appeal);            }            // 4. 关键API调用            String AppealMessage = new ApiHaosen().callExternalAppealApi();            ObjectMapper objectMapper = new ObjectMapper();            JsonNode rootNode = objectMapper.readTree(AppealMessage);            if (rootNode.get("code").asInt() == 200) {                // 5. 全部成功后的响应                fileMessage.setProcessedCount(appeals.size());                fileMessage.setMessage("success");                fileMessage.setAppealMessage("申诉数据推送成功");            } else {                fileMessage.setMessage(rootNode.get("msg").asText());                fileMessage.setAppealMessage("申诉数据推送失败");            }            return ApiResponseDTO.success(fileMessage);        } catch (RuntimeException e) {            // 业务异常（如API调用失败）            fileMessage.setMessage("fail");            fileMessage.setAppealMessage("申诉数据推送失败");            return ApiResponseDTO.success(fileMessage);        } catch (Exception e) {            // 系统异常            fileMessage.setMessage("系统处理异常");            fileMessage.setAppealMessage("申诉数据处理失败");            return ApiResponseDTO.success(fileMessage);        }    }    //页面上单条处理申诉数据    @Override    public ApiResponseDTO<HaoSenFileMessageDTO> handleAppealData(HaoSenAppealDataVO haoSenAppealDataVO) {        HaoSenFileMessageDTO appealDataMessage = new HaoSenFileMessageDTO();        ObjectMapper objectMapper = new ObjectMapper();        //处理逻辑        //1. 数据库操作（事务内）        sqlMapper.deleteAllHaoSenData();        sqlMapper.inputHaoSenUpdateData(haoSenAppealDataVO);//        测试逻辑//        return ApiResponseDTO.success(appealDataMessage);        try {            String AppealMessage = new ApiHaosen().callExternalAppealApi();            JsonNode rootNode = objectMapper.readTree(AppealMessage);            if (rootNode.get("code").asInt() == 200) {                // 5. 全部成功后的响应                appealDataMessage.setProcessedCount(1);                appealDataMessage.setMessage("success");                appealDataMessage.setAppealMessage("更新数据推送成功");            } else {                appealDataMessage.setMessage(rootNode.get("msg").asText());                appealDataMessage.setAppealMessage("更新数据推送失败");            }            return ApiResponseDTO.success(appealDataMessage);        } catch (RuntimeException e) {            // 业务异常（如API调用失败）            appealDataMessage.setMessage("fail");            appealDataMessage.setAppealMessage("更新数据推送失败");            return ApiResponseDTO.success(appealDataMessage);        } catch (Exception e) {            // 系统异常            appealDataMessage.setMessage("系统处理异常");            appealDataMessage.setAppealMessage("更新数据处理失败");            return ApiResponseDTO.success(appealDataMessage);        }    }}