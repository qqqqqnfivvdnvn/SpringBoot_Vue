<template>  <!--  class="chart"-->  <div ref="chart" style="width: 37rem; height: 16rem;"></div></template><script setup>import { ref, onMounted, onUnmounted } from 'vue';import * as echarts from 'echarts';import axios from "axios";const chart = ref(null);let myChart = null;let chartData = null;let lastFetchTime = 0;const CACHE_DURATION = 5 * 60 * 1000; // 5分钟缓存// 防抖函数const debounce = (func, wait) => {  let timeout;  return function executedFunction(...args) {    const later = () => {      clearTimeout(timeout);      func(...args);    };    clearTimeout(timeout);    timeout = setTimeout(later, wait);  };};// 获取数据const fetchChartData = async () => {  const now = Date.now();  // 检查缓存  if (chartData && (now - lastFetchTime < CACHE_DURATION)) {    return chartData;  }  try {    const response = await axios.post('/api/homeData/getMainPieData');    if (response.data.code === 200) {      chartData = response.data.data.map(item => ({        name: item.name,        value: Number(item.value) || 0      }));      lastFetchTime = now;      return chartData;    }  } catch (error) {    console.error('获取数据失败:', error);    // 返回缓存数据或空数组    return chartData || [];  }};// 颜色映射const colorMap = {  '医院': '#6da1e4',  '药店': '#40b786',  '商业': '#ffa305'};// 初始化图表const initChart = async () => {  if (!chart.value) return;  // 如果已存在实例，先销毁  if (myChart) {    myChart.dispose();  }  // 初始化图表  myChart = echarts.init(chart.value, null, {    renderer: 'svg',    devicePixelRatio: Math.min(window.devicePixelRatio, 2) // 限制最大DPI  });  // 获取数据  const baseData = await fetchChartData();  // 处理数据  const processedData = baseData.map(item => ({    ...item,    itemStyle: { color: colorMap[item.name] }  }));  // 计算总数  const total = baseData.reduce((sum, item) => sum + item.value, 0);  // 配置项 - 保持原有风格不变  const option = {    title: {      text: '主数据数据占比',      left: 'center',      textStyle: {        color: '#333333',        fontSize: 13,        fontWeight: 'bold',        fontFamily: 'Arial, sans-serif',      },    },    tooltip: {      trigger: 'item',      formatter: function(params) {        const percent = total > 0 ? ((params.value / total) * 100).toFixed(1) : '0.0';        return `          <div style="font-family:Arial,sans-serif;color:#333333;font-size:11px">            ${params.name}<br/>            数量: <span style="font-weight:bold">${params.value}</span><br/>            占比: <span style="font-weight:bold">${percent}%</span>          </div>        `;      },      textStyle: {        color: '#333333',        fontFamily: 'Arial, sans-serif',        fontSize: 12,      },    },    legend: {      orient: 'vertical',      right: 20,      top: 'center',      data: baseData.map(item => item.name),      textStyle: {        color: '#333333',        fontFamily: 'Arial, sans-serif',        fontSize: 12,      },      itemWidth: 20,      itemHeight: 10,    },    grid: {      backgroundColor: '#F5F5F5',      borderColor: '#E0E0E0',    },    series: [{      type: 'pie',      radius: ['45%', '75%'],      center: ['50%', '55%'],      avoidLabelOverlap: false,      itemStyle: {        borderRadius: 10,        borderColor: '#fff',        borderWidth: 2,      },      label: {        show: true,        formatter: '{b}: {d}%',        color: '#333333',        fontFamily: 'Arial, sans-serif',        fontSize: 12      },      emphasis: {        itemStyle: {          shadowBlur: 10,          shadowOffsetX: 0,          shadowColor: 'rgba(0, 0, 0, 0.2)'        },        label: {          show: true,          fontSize: 12        }      },      labelLine: {        lineStyle: {          color: '#E0E0E0'        },        smooth: 0.2,        length: 10,        length2: 15      },      data: processedData,      // 添加性能优化配置      animation: true,      animationDuration: 500,      animationEasing: 'cubicOut',      animationThreshold: 2000, // 数据量小于2000才执行动画    }]  };  // 设置配置项，使用懒更新  myChart.setOption(option, {    lazyUpdate: true, // 启用懒更新    notMerge: true  });  return myChart;};// 防抖的resize处理const handleResize = debounce(() => {  if (myChart) {    myChart.resize();  }}, 150);onMounted(async () => {  try {    await initChart();    // 添加resize监听（防抖处理）    window.addEventListener('resize', handleResize);    // 监听容器尺寸变化    if (typeof ResizeObserver !== 'undefined' && chart.value) {      const resizeObserver = new ResizeObserver(handleResize);      resizeObserver.observe(chart.value);    }  } catch (error) {    console.error('图表初始化失败:', error);  }});onUnmounted(() => {  // 移除事件监听  window.removeEventListener('resize', handleResize);  // 销毁图表实例  if (myChart) {    myChart.dispose();    myChart = null;  }});// 暴露刷新方法const refreshChart = async () => {  chartData = null; // 清除缓存  if (myChart) {    await initChart();  }};// 可选：暴露给父组件defineExpose({  refreshChart});</script><style scoped>.chart {  width: 100%;  height: 100%;}</style>